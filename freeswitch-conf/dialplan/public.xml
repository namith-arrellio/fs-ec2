<!--
    PUBLIC CONTEXT - Inbound calls from SIP trunks (Telnyx)
    
    All inbound calls are routed to ESL (call_router.py) for handling.
    This is a static dialplan for reliability - no XML CURL dependency.
-->
<include>
  <context name="public">

    <!-- Prevent routing loops -->
    <extension name="unloop">
      <condition field="${unroll_loops}" expression="^true$"/>
      <condition field="${sip_looped_call}" expression="^true$">
        <action application="deflect" data="${destination_number}"/>
      </condition>
    </extension>

    <!-- Tag as outside call for routing logic -->
    <extension name="outside_call" continue="true">
      <condition>
        <action application="set" data="outside_call=true"/>
        <action application="set" data="call_direction=inbound"/>
        <action application="export" data="RFC2822_DATE=${strftime(%a, %d %b %Y %T %z)}"/>
      </condition>
    </extension>

    <!-- Route ALL inbound calls to ESL for handling -->
    <extension name="inbound_to_esl">
      <condition field="destination_number" expression="^(.*)$">
        <action application="socket" data="127.0.0.1:5002 async full"/>
      </condition>
    </extension>

  </context>
</include>
